<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damas Brasileiras PvP</title>
    
    <!-- Link para ícones (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- ================================== START OF CSS ================================== -->
    <style>
        /* Estilo geral */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #2c2f33;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
        }

        #game-container {
            background-color: #23272a;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
        }

        h1, h2 {
            color: #ffffff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* --- Tela de Login --- */
        #login-screen input {
            display: block;
            margin: 15px auto;
            padding: 12px;
            width: 85%;
            border-radius: 8px;
            border: 2px solid #7289da;
            background-color: #40444b;
            color: #ffffff;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #login-screen input:focus {
            outline: none;
            border-color: #ffffff;
        }

        #login-screen button {
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background-color: #5865f2;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
        }

        #login-screen button:hover {
            background-color: #4752c4;
        }
        
        #login-screen button:active {
            transform: scale(0.98);
        }

        #login-status {
            margin-top: 15px;
            color: #faa61a;
            min-height: 24px;
            font-size: 16px;
        }

        /* --- Tela do Jogo --- */
        .hidden {
            display: none;
        }

        .player-info-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.1em;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: #40444b;
            transition: all 0.3s;
        }

        .player-info.active {
            color: #ffffff;
            background-color: #5865f2;
            box-shadow: 0 0 10px #5865f2;
        }

        .player-piece-indicator {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        /* --- Tabuleiro --- */
        #board-container {
            display: flex;
            justify-content: center;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            aspect-ratio: 1 / 1;
            border: 5px solid #6f4e37;
            border-radius: 5px;
            overflow: hidden;
        }

        .square {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .square.light {
            background-color: #f0d9b5; /* Madeira clara */
        }

        .square.dark {
            background-color: #b58863; /* Madeira escura */
        }

        /* --- Peças --- */
        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: inset 0 -4px 4px rgba(0,0,0,0.3), 0 2px 3px rgba(0,0,0,0.5);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s;
        }
        
        .piece.player-0 {
            background-color: #ffffff; /* Peças brancas */
        }

        .piece.player-1 {
            background-color: #313131; /* Peças pretas */
        }
        
        /* Peças do Rei (Dama) */
        .piece.king::after {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: "\f521"; /* Ícone de coroa */
            font-size: 60%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        .piece.player-0.king::after {
            color: #313131;
        }

        .piece.player-1.king::after {
            color: #ffffff;
        }

        /* Destaques e Animações */
        .selected {
            box-shadow: 0 0 0 4px #5865f2, inset 0 -4px 4px rgba(0,0,0,0.3);
            transform: scale(1.1);
        }

        .valid-move {
            background-color: rgba(88, 101, 242, 0.5);
            border-radius: 50%;
            width: 50%;
            height: 50%;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0px rgba(255, 82, 82, 0.7);
            }
            100% {
                box-shadow: 0 0 0 15px rgba(255, 82, 82, 0);
            }
        }
        
        .must-capture .piece {
             animation: pulse 1.5s infinite;
        }

        /* Mensagem de Status e Botão de Reiniciar */
        #status-message {
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
            min-height: 28px;
        }
        
        #restart-game-btn {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #restart-game-btn:hover {
            background-color: #218838;
        }
    </style>
    <!-- =================================== END OF CSS =================================== -->
</head>
<body>

    <div id="game-container">
        <h1>Damas Brasileiras PvP</h1>

        <!-- Tela de Login/Entrada -->
        <div id="login-screen">
            <h2>Encontrar Partida</h2>
            <input type="text" id="nickname-input" placeholder="Digite seu apelido" maxlength="15">
            <button id="find-game-btn">Encontrar Partida</button>
            <p id="login-status"></p>
        </div>

        <!-- Tela do Jogo (inicialmente oculta) -->
        <div id="game-screen" class="hidden">
            <div class="player-info-container">
                <div id="player-0-info" class="player-info">
                    <span id="player-0-name" class="player-name">Jogador 1</span>
                    <span class="player-piece-indicator player-0"></span>
                </div>
                <div id="player-1-info" class="player-info">
                    <span class="player-piece-indicator player-1"></span>
                    <span id="player-1-name" class="player-name">Jogador 2</span>
                </div>
            </div>

            <div id="board-container">
                <div id="board"></div>
            </div>
            
            <p id="status-message">Aguardando movimento...</p>
            <button id="restart-game-btn" class="hidden">Jogar Novamente</button>
        </div>
    </div>

    <!-- Biblioteca Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- ================================== START OF JAVASCRIPT ================================== -->
    <script>
        (function() {
            'use strict';

            // --- CONFIGURAÇÃO ---
            const SERVER_URL = "https://fronted-7tb2.onrender.com";
            const socket = io(SERVER_URL, {
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
            });

            // --- DOM Elements ---
            const loginScreen = document.getElementById('login-screen');
            const gameScreen = document.getElementById('game-screen');
            const nicknameInput = document.getElementById('nickname-input');
            const findGameBtn = document.getElementById('find-game-btn');
            const loginStatus = document.getElementById('login-status');
            const boardElement = document.getElementById('board');
            const statusMessage = document.getElementById('status-message');
            const restartGameBtn = document.getElementById('restart-game-btn');
            const player0Name = document.getElementById('player-0-name');
            const player1Name = document.getElementById('player-1-name');
            const player0Info = document.getElementById('player-0-info');
            const player1Info = document.getElementById('player-1-info');

            // --- Game State ---
            let gameId = null;
            let myPlayerIndex = -1;
            let selectedPiece = null; // { row, col, element }

            // --- FUNÇÕES DO JOGO ---

            /** Limpa o tabuleiro e renderiza o estado atual */
            function renderBoard(board, mustCaptureFrom, currentPlayer, isMyTurn) {
                boardElement.innerHTML = '';
                clearHighlights();

                const mustCaptureCoords = mustCaptureFrom ? `${mustCaptureFrom[0]}-${mustCaptureFrom[1]}` : null;
                const captures = getAllPossibleCaptures(board, currentPlayer);

                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const square = document.createElement('div');
                        square.classList.add('square');
                        square.classList.add((row + col) % 2 === 0 ? 'light' : 'dark');
                        square.dataset.row = row;
                        square.dataset.col = col;

                        const pieceData = board[row][col];
                        if (pieceData) {
                            const piece = document.createElement('div');
                            piece.classList.add('piece', `player-${pieceData.player}`);
                            if (pieceData.isKing) {
                                piece.classList.add('king');
                            }
                            square.appendChild(piece);

                            // Adiciona a classe de animação se for a vez do jogador e essa peça pode/deve capturar
                            if (isMyTurn) {
                                if (mustCaptureCoords && `${row}-${col}` === mustCaptureCoords) {
                                    square.classList.add('must-capture');
                                } else if (!mustCaptureCoords && captures.some(c => c.from[0] === row && c.from[1] === col)) {
                                    square.classList.add('must-capture');
                                }
                            }
                        }
                        boardElement.appendChild(square);
                    }
                }
            }
            
            /** Atualiza o status do jogo e a vez do jogador */
            function updateGameUI(gameState) {
                gameId = gameState.gameId;
                player0Name.textContent = gameState.players[0].nickname;
                player1Name.textContent = gameState.players[1].nickname;
                
                myPlayerIndex = gameState.players.findIndex(p => p.id === socket.id);
                if (myPlayerIndex === -1) { // Sou um espectador?
                    console.log("Observando o jogo.");
                }

                updateTurnIndicator(gameState.currentPlayer, gameState.winner);
                renderBoard(gameState.board, gameState.mustCaptureFrom, gameState.currentPlayer, myPlayerIndex === gameState.currentPlayer);
                updateStatusMessage(gameState);
            }

            /** Atualiza a mensagem de status (Sua vez, Vez do oponente, etc.) */
            function updateStatusMessage(gameState) {
                if (gameState.winner !== null) {
                    const winnerName = gameState.players[gameState.winner].nickname;
                    statusMessage.textContent = `${winnerName} venceu o jogo!`;
                    statusMessage.style.color = '#28a745';
                    restartGameBtn.classList.remove('hidden');
                    return;
                }

                if (gameState.gameState === 'waiting') {
                    statusMessage.textContent = 'Aguardando oponente...';
                    return;
                }
                
                const isMyTurn = myPlayerIndex === gameState.currentPlayer;
                if(isMyTurn) {
                    statusMessage.textContent = 'É a sua vez!';
                    statusMessage.style.color = '#5865f2';
                } else {
                    const opponentName = gameState.players[gameState.currentPlayer]?.nickname || 'Oponente';
                    statusMessage.textContent = `Vez de ${opponentName}`;
                    statusMessage.style.color = '#ffffff';
                }
            }

            /** Destaca qual jogador está ativo */
            function updateTurnIndicator(currentPlayer, winner) {
                 if (winner !== null) {
                    player0Info.classList.remove('active');
                    player1Info.classList.remove('active');
                    return;
                 }
                 player0Info.classList.toggle('active', currentPlayer === 0);
                 player1Info.classList.toggle('active', currentPlayer === 1);
            }

            /** Lógica de clique no tabuleiro */
            function handleSquareClick(event) {
                const square = event.target.closest('.square');
                if (!square) return;

                const row = parseInt(square.dataset.row);
                const col = parseInt(square.dataset.col);
                const pieceElement = square.querySelector('.piece');
                
                if (selectedPiece) {
                    // Clicou em um possível movimento ou em qualquer outro lugar para desmarcar
                    if (square.querySelector('.valid-move')) {
                        socket.emit('makeMove', {
                            gameId,
                            fromRow: selectedPiece.row,
                            fromCol: selectedPiece.col,
                            toRow: row,
                            toCol: col
                        });
                    }
                    // Desmarcar peça
                    clearHighlights();
                    selectedPiece = null;
                } else if (pieceElement) {
                    // Tentando selecionar uma nova peça
                    const playerClass = pieceElement.classList.contains('player-0') ? 0 : 1;
                    if (playerClass === myPlayerIndex) {
                        selectedPiece = { row, col, element: pieceElement };
                        pieceElement.classList.add('selected');
                        // TODO: Mostrar movimentos válidos
                        // Por simplicidade, essa lógica fica no backend, mas podemos mostrar destaques aqui.
                    }
                }
            }
            
            function clearHighlights() {
                document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll('.valid-move').forEach(el => el.remove());
                document.querySelectorAll('.must-capture').forEach(el => el.classList.remove('must-capture'));
            }
            
            // Lógica para encontrar capturas obrigatórias (simplificada para UI)
            function getAllPossibleCaptures(board, player) {
                const captures = [];
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const piece = board[r][c];
                        if (piece && piece.player === player) {
                            // Direções de movimento
                            const dirs = piece.isKing ? [[-1,-1],[-1,1],[1,-1],[1,1]] : (player === 0 ? [[-1,-1],[-1,1]] : [[1,-1],[1,1]]);
                            for(const [dr, dc] of dirs) {
                                const landRow = r + dr * 2;
                                const landCol = c + dc * 2;
                                if (landRow >= 0 && landRow < 8 && landCol >= 0 && landCol < 8) {
                                    const capturedPiece = board[r+dr][c+dc];
                                    if(capturedPiece && capturedPiece.player !== player && board[landRow][landCol] === null) {
                                        captures.push({ from: [r, c], to: [landRow, landCol] });
                                    }
                                }
                            }
                        }
                    }
                }
                return captures;
            }
            

            // --- SOCKET EVENT LISTENERS ---

            socket.on('connect', () => {
                console.log('Conectado ao servidor!', socket.id);
                loginStatus.textContent = '';
            });

            socket.on('connect_error', () => {
                loginStatus.textContent = 'Não foi possível conectar ao servidor. Tentando novamente...';
            });
            
            socket.on('error', (data) => {
                console.error('Erro do servidor:', data.message);
                loginStatus.textContent = `Erro: ${data.message}`;
            });

            socket.on('waitingForPlayer', () => {
                loginStatus.textContent = 'Aguardando um oponente...';
                findGameBtn.disabled = true;
            });

            socket.on('gameFound', (data) => {
                loginScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                restartGameBtn.classList.add('hidden');
                updateGameUI(data.gameState);
            });

            socket.on('gameUpdate', (data) => {
                const isMyTurn = myPlayerIndex === data.currentPlayer;
                renderBoard(data.board, data.mustCaptureFrom, data.currentPlayer, isMyTurn);
                updateTurnIndicator(data.currentPlayer, data.winner);
                updateStatusMessage(data); // Reutiliza a lógica completa
                clearHighlights();
                selectedPiece = null;
            });

            socket.on('moveError', (data) => {
                // Fornece feedback visual rápido sobre o erro
                statusMessage.textContent = data.error;
                statusMessage.style.color = '#f04747';
                setTimeout(() => {
                     // Volta para a mensagem de status normal após um tempo
                     const isMyTurn = myPlayerIndex === parseInt(player0Info.classList.contains('active') ? '0' : '1');
                     if(isMyTurn) {
                        statusMessage.textContent = 'É a sua vez!';
                        statusMessage.style.color = '#5865f2';
                    }
                }, 2000);
            });    
            
            socket.on('gameEnd', (data) => {
                const winnerName = data.winnerName;
                statusMessage.textContent = `${winnerName} venceu o jogo!`;
                statusMessage.style.color = '#43b581';
                restartGameBtn.classList.remove('hidden');
                updateTurnIndicator(null, data.winner);
            });
            
            socket.on('playerDisconnected', (data) => {
                statusMessage.textContent = `Oponente desconectou. Você venceu!`;
                statusMessage.style.color = '#43b581';
                restartGameBtn.classList.remove('hidden');
                updateTurnIndicator(null, data.winner);
            });

            socket.on('gameRestart', (data) => {
                restartGameBtn.classList.add('hidden');
                statusMessage.style.color = '#ffffff'; // Reseta a cor da mensagem
                updateGameUI(data.gameState);
            });
            
            // --- DOM EVENT LISTENERS ---

            findGameBtn.addEventListener('click', () => {
                const nickname = nicknameInput.value.trim();
                if (nickname) {
                    socket.emit('findGame', { nickname });
                    loginStatus.textContent = 'Procurando partida...';
                    findGameBtn.disabled = true;
                } else {
                    loginStatus.textContent = 'Por favor, insira um apelido.';
                }
            });

            boardElement.addEventListener('click', handleSquareClick);
            
            restartGameBtn.addEventListener('click', () => {
                if(gameId) {
                    socket.emit('restartGame', { gameId });
                }
            });
            
        })();
    </script>
    <!-- =================================== END OF JAVASCRIPT =================================== -->
</body>
</html>
       
